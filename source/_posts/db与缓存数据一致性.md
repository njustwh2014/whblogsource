---
title: db与缓存数据一致性
date: 2020-06-09 11:29:33
tags: [数据一致性]
categories: 面试
---

[参考文章](https://www.cnblogs.com/rjzheng/p/9041659.html)

四种处理时序：
+ 先更新缓存，再更新数据库
+ 先更新数据库，再更新缓存
+ 先删除缓存，再更新数据库
+ 先更新数据库，再删除缓存
<!--more-->
**为缓存设置过期时间可以保证最终一致性。**

## 先更新缓存，再更新数据库

这种方式隐患最大，通常db的数据持久化能力强于缓存，因此数据主体应当是数据库。如果先更新缓存，再根据缓存数据去更新数据库，当遇到数据库更新失败的情况，数据库会重试更新，当重试时间过长，缓存已经失效，此时缓存会去读取数据库中旧的数据，此时数据库更新的数据也为旧的数据，从而导致**数据丢失**。

那么可以不设置缓存过期时间，这可能会导致某些数据永远不一致，也考验缓存的持久化能力。

## 先更新数据库，再更新缓存

这种方式也会导致数据不一致，但问题更应聚焦于性能开销方面，通常缓存用于提升查询效率，当某些业务读操作不那么频繁，每次更新数据库都需要使用一些计算资源去计算缓存值，是一件得不偿失的事情。

## 先删除缓存，再更新数据库

双删策略保证数据一致性

## 先更新数据库，再删除缓存

这种数据一致性保证最好，出现数据不一致的情况概率很低，需要满足：


假设这会有两个请求，一个请求A做查询操作，一个请求B做更新操作，那么会有如下情形产生
（1）缓存刚好失效
（2）请求A查询数据库，得一个旧值
（3）请求B将新值写入数据库
（4）请求B删除缓存
（5）请求A将查到的旧值写入缓存

除了设置缓存过期时间，还可以在此基础上设置异步延时删除策略，以及删除失败重试
